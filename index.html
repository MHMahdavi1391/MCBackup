<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>بکاپ مپ‌های Minecraft</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: sans-serif; background: #f0f0f0; padding: 10px; }
h1 { text-align: center; }
#worldList { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 15px; }
.world { background: #fff; border-radius: 10px; padding: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); text-align: center; }
.world img { width: 100%; height: 100px; object-fit: cover; border-radius: 5px; }
button { margin: 5px 0; padding: 7px 12px; border-radius: 5px; border: none; background: #007bff; color: #fff; cursor: pointer; width: 100%; font-size: 14px; }
button:hover { background: #0056b3; }
</style>
</head>
<body>
<h1>بکاپ مپ‌های Minecraft</h1>
<button id="chooseFolder">انتخاب پوشه Com.Mojang</button>
<div id="worldList"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
async function chooseFolder() {
    try {
        const baseDirHandle = await window.showDirectoryPicker();
        const worldList = document.getElementById('worldList');
        worldList.innerHTML = '';

        let worldsHandle;
        for await (const [name, handle] of baseDirHandle.entries()) {
            if (handle.kind === 'directory' && name === 'minecraftWorlds') {
                worldsHandle = handle;
                break;
            }
            if (handle.kind === 'directory') {
                for await (const [subName, subHandle] of handle.entries()) {
                    if (subHandle.kind === 'directory' && subName === 'minecraftWorlds') {
                        worldsHandle = subHandle;
                        break;
                    }
                }
            }
            if (worldsHandle) break;
        }

        if (!worldsHandle) {
            alert('پوشه minecraftWorlds پیدا نشد.');
            return;
        }

        for await (const [worldName, worldHandle] of worldsHandle.entries()) {
            if (worldHandle.kind !== 'directory') continue;

            const worldDiv = document.createElement('div');
            worldDiv.className = 'world';

            // اسم واقعی مپ
            let displayName = worldName;
            try {
                const levelFile = await worldHandle.getFileHandle('levelname.txt');
                const levelData = await levelFile.getFile();
                displayName = await levelData.text();
            } catch(e) {}

            const title = document.createElement('h3');
            title.textContent = displayName;
            worldDiv.appendChild(title);

            // عکس مپ
            let img = document.createElement('img');
            let foundImg = false;
            const exts = ['png','jpg','jpeg'];
            for(const ext of exts) {
                try {
                    const imgFileHandle = await worldHandle.getFileHandle(`world_icon.${ext}`);
                    const file = await imgFileHandle.getFile();
                    img.src = URL.createObjectURL(file);
                    foundImg = true;
                    break;
                } catch(e) { continue; }
            }
            if(!foundImg) img.src = 'https://via.placeholder.com/180x100?text=No+Image';
            worldDiv.appendChild(img);

            // دکمه بکاپ .mcworld
            const mcworldBtn = document.createElement('button');
            mcworldBtn.textContent = '.mcworld';
            mcworldBtn.onclick = async () => { await backupWorld(worldHandle, displayName+'.mcworld'); };
            worldDiv.appendChild(mcworldBtn);

            // دکمه بکاپ .mctemplate
            const mctemplateBtn = document.createElement('button');
            mctemplateBtn.textContent = '.mctemplate';
            mctemplateBtn.onclick = async () => { await backupWorld(worldHandle, displayName+'.mctemplate'); };
            worldDiv.appendChild(mctemplateBtn);

            worldList.appendChild(worldDiv);
        }

    } catch(err) {
        console.error(err);
    }
}

// تابع بکاپ کامل
async function backupWorld(dirHandle, filename) {
    const zip = new JSZip();

    async function addFilesToZip(zipObj, handle) {
        for await (const [name, entry] of handle.entries()) {
            if (entry.kind === 'file') {
                try {
                    const file = await entry.getFile();
                    zipObj.file(name, file);
                } catch(e) { console.warn('Error reading file', name); }
            } else if (entry.kind === 'directory') {
                const folder = zipObj.folder(name);
                await addFilesToZip(folder, entry);
            }
        }
    }

    await addFilesToZip(zip, dirHandle);
    const blob = await zip.generateAsync({ type:'blob' });

    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();

    // پیام موفقیت
    alert(`بکاپ ${filename} آماده شد و دانلود شد!`);
}

document.getElementById('chooseFolder').addEventListener('click', chooseFolder);
</script>
</body>
</html>
