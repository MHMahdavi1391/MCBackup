<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>بکاپ مپ‌های Minecraft</title>
<style>
body { font-family: sans-serif; background: #f0f0f0; padding: 20px; }
h1 { text-align: center; }
#worldList { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-top: 20px; }
.world { background: #fff; border-radius: 10px; padding: 10px; width: 200px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); text-align: center; }
.world img { width: 180px; height: 100px; object-fit: cover; border-radius: 5px; }
button { margin: 5px; padding: 5px 10px; border-radius: 5px; border: none; background: #007bff; color: #fff; cursor: pointer; }
button:hover { background: #0056b3; }
</style>
</head>
<body>
<h1>بکاپ مپ‌های Minecraft</h1>
<button id="chooseFolder">انتخاب پوشه Com.Mojang</button>
<div id="worldList"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
async function chooseFolder() {
    try {
        const baseDirHandle = await window.showDirectoryPicker();
        const worldList = document.getElementById('worldList');
        worldList.innerHTML = '';

        // جستجو برای minecraftWorlds
        let worldsHandle;
        for await (const [name, handle] of baseDirHandle.entries()) {
            if (handle.kind === 'directory' && name === 'minecraftWorlds') {
                worldsHandle = handle;
                break;
            }
            if (handle.kind === 'directory') {
                for await (const [subName, subHandle] of handle.entries()) {
                    if (subHandle.kind === 'directory' && subName === 'minecraftWorlds') {
                        worldsHandle = subHandle;
                        break;
                    }
                }
            }
            if (worldsHandle) break;
        }

        if (!worldsHandle) {
            alert('پوشه minecraftWorlds پیدا نشد.');
            return;
        }

        for await (const [worldName, worldHandle] of worldsHandle.entries()) {
            if (worldHandle.kind !== 'directory') continue;

            const worldDiv = document.createElement('div');
            worldDiv.className = 'world';

            // خواندن levelname.txt برای اسم واقعی
            let displayName = worldName;
            try {
                const levelFile = await worldHandle.getFileHandle('levelname.txt');
                const levelData = await levelFile.getFile();
                displayName = await levelData.text();
            } catch(e) { /* fallback: اسم پوشه */ }

            const title = document.createElement('h3');
            title.textContent = displayName;
            worldDiv.appendChild(title);

            // نمایش عکس: بررسی پسوندهای png, jpg, jpeg
            let img = document.createElement('img');
            let foundImg = false;
            const exts = ['png','jpg','jpeg'];
            for(const ext of exts) {
                try {
                    const imgFileHandle = await worldHandle.getFileHandle(`world_icon.${ext}`);
                    const file = await imgFileHandle.getFile();
                    img.src = URL.createObjectURL(file);
                    foundImg = true;
                    break;
                } catch(e) { continue; }
            }
            if(!foundImg) img.src = 'https://via.placeholder.com/180x100?text=No+Image';
            worldDiv.appendChild(img);

            // دکمه .mcworld
            const mcworldBtn = document.createElement('button');
            mcworldBtn.textContent = '.mcworld';
            mcworldBtn.onclick = async () => { await downloadWorld(worldHandle, displayName+'.mcworld'); };
            worldDiv.appendChild(mcworldBtn);

            // دکمه .mctemplate
            const mctemplateBtn = document.createElement('button');
            mctemplateBtn.textContent = '.mctemplate';
            mctemplateBtn.onclick = async () => { await downloadWorld(worldHandle, displayName+'.mctemplate'); };
            worldDiv.appendChild(mctemplateBtn);

            worldList.appendChild(worldDiv);
        }

    } catch(err) {
        console.error(err);
    }
}

// zip و دانلود
async function downloadWorld(dirHandle, filename) {
    const zip = new JSZip();
    await addFolderToZip(zip, dirHandle);
    const blob = await zip.generateAsync({type:"blob"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
}

// افزودن پوشه‌ها و فایل‌ها به zip
async function addFolderToZip(zipObj, dirHandle, path='') {
    for await (const [name, handle] of dirHandle.entries()) {
        if (handle.kind === 'file') {
            try {
                const file = await handle.getFile();
                zipObj.file(path + name, file);
            } catch(e){ console.warn('Error reading file', name); }
        } else if (handle.kind === 'directory') {
            const folder = zipObj.folder(path + name);
            await addFolderToZip(folder, handle, '');
        }
    }
}

document.getElementById('chooseFolder').addEventListener('click', chooseFolder);
</script>
</body>
</html>
